<html>
<head>
<meta charset='utf-8'>
<title>E8</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 0px;
    font-family: sans-serif;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="utils.js"></script>
<script src="particles.js"></script>
<script>

var g_rowHeight = 34

// math formatting
var m = {
    x : function (x) {
        return $('<span style="font-family:serif"/>').text(x)
    },
    i : function (x) {
        return $('<i style="font-family:serif"/>').text(x)
    },
    f : function (a, b) {
        return $('<table/>').append(
            $('<tr style="border-bottom:1px solid black"/>').append($('<td align="middle"/>').append(a.css('font-size', 'small')))
        ).append(
            $('<tr/>').append($('<td align="middle"/>').append(b.css('font-size', 'small')))
        )
    },
    supsub : function (a, b) {
        if (!a) a = $('<span>&nbsp;</span>')
        if (!b) b = $('<span>&nbsp;</span>')
        return $('<table/>').append(
            $('<tr/>').append($('<td/>').append(a.css('font-size', 'small')))
        ).append(
            $('<tr/>').append($('<td/>').append(b.css('font-size', 'small')))
        )
    },
    c : function (a, b) {
        return $('<table/>').append($('<tr/>').append($('<td/>').append(a)).append($('<td/>').append(b)))
    },
    sqrt : function (x) {
        return m.c($('<span style="font-size:90%">&radic;</span>'), $('<div style="border-top:1px solid black"/>').append(x))
    }
}

function p2p_id_to_color(id) {
    var low = id % 16
    var high = Math.floor(id / 16)
    var r = low * 16 + low
    var g = high * 16 + high
    var b = high * 16 + low
    return 'rgb(' + r + ',' + g + ',' + b + ')'
}

function p2p_color_to_id(r, g, b, a) {
    if (a != 255) return
    var low = r % 16
    if (low != Math.floor(r / 16)) return
    var high = g % 16
    if (high != Math.floor(g / 16)) return
    if (high != Math.floor(b / 16)) return
    if (low != b % 16) return
    return high * 16 + low
}

;(function () {
    function circle(g, x, y, size) {
        g.beginPath()
        g.arc(x, y, size, 0, tau)
    }
    function square(g, x, y, size) {
        g.beginPath()
        g.moveTo(x - size, y - size)
        g.lineTo(x - size, y + size)
        g.lineTo(x + size, y + size)
        g.lineTo(x + size, y - size)
        g.closePath()
    }
    function dia(g, x, y, size) {
        g.beginPath()
        g.lineTo(x - size, y)
        g.lineTo(x, y + size)
        g.lineTo(x + size, y)
        g.lineTo(x, y - size)
        g.closePath()
    }
    var glyphu = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [-1/2, 1/Math.sqrt(3)],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var glyphd = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-3/4, 1/(4 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var sizeMap = {
        's' : .75,
        'm' : .85,
        'b' : 1.0
    }
    function glyph(g, x, y, scale, sym) {
        var size = scale * sizeMap[sym[0]]
        var mx = size * (sym[1] == 'l' ? 1 : -1)
        var my = size * (sym[3] == 'p' ? 1 : -1)
        var gl = (sym[2] == 'u') == (sym[3] == 'p') ? glyphu : glyphd
        g.beginPath()
        for (var i = 0; i < gl.length; i++) {
            if (i == 0)
                g.moveTo(x + mx * gl[i][0], y + my * gl[i][1])
            else
                g.lineTo(x + mx * gl[i][0], y + my * gl[i][1])
        }
        g.closePath()
    }
    renderParticle = function (g, x, y, scale, lineWidth, p, p2p, justLine) {
        if (p2p) p2p = p2p_id_to_color(p.id)
        var size = p.symbol[0] == 's' ? .8 : 1
        var sym = p.symbol.slice(1)
        if (sym == 'cir') {
            circle(g, x, y, size * scale / 2)
        } else if (sym == 'squ') {
            square(g, x, y, size * .4 * scale)
        } else if (sym == 'dia') {
            dia(g, x, y, size * .4 * Math.sqrt(2) * scale)
        } else {
            glyph(g, x, y, scale, p.symbol)
        }
        if (!justLine) {
            g.fillStyle = p2p || colorMap[p.color]
            g.fill()
        }
        g.strokeStyle = p2p || justLine || 'black'
        g.lineWidth = lineWidth
        g.stroke()
    }
})();

function drawVisualization(w, h) {

    var pixelToParticleMap = null

    function updatePixelToParticleMap() {
        var c = draw(true)
        var g = c[0].getContext('2d')
        pixelToParticleMap = g.getImageData(0, 0, w, h).data
    }

    function draw(p2p) {
        var c = $('<canvas/>').attr('width', w).attr('height', h)
        var g = c[0].getContext('2d')
        g.setTransform(w/3, 0, 0, -h/3, w/2, h/2)
        var unitWidth = 3/w

        var H = g_m.rotate.H
        var V = g_m.rotate.V

        function projectParticle(id) {
            var p = particles[id - 1]
            return [dot(H, p.e8coord), dot(V, p.e8coord)]
        }

        var scale = 0.1

        if (!p2p && g_m.interactions.interaction) {
            var x = _.map(g_m.interactions.interaction, projectParticle)

            g.beginPath()
            g.moveTo(x[0][0], x[0][1])
            g.lineTo(x[1][0], x[1][1])
            g.lineWidth = unitWidth * 7
            g.strokeStyle = 'yellow'
            g.stroke()

            g.beginPath()
            g.arc(x[0][0], x[0][1], scale, 0, tau)
            g.fillStyle = 'yellow'
            g.fill()

            g.beginPath()
            g.arc(x[1][0], x[1][1], scale, 0, tau)
            g.fillStyle = 'yellow'
            g.fill()

            g.beginPath()
            g.moveTo(0, 0)
            g.lineTo(x[2][0], x[2][1])
            g.lineWidth = unitWidth * 7
            g.strokeStyle = 'lightgreen'
            g.stroke()

            g.beginPath()
            g.arc(x[2][0], x[2][1], scale, 0, tau)
            g.fillStyle = 'lightgreen'
            g.fill()
        }

        if (g_m.showTriality && !p2p) {
            _.each(trialities, function (t) {
                var locs = _.map(t, projectParticle)
                g.beginPath()
                g.moveTo(locs[2][0], locs[2][1])
                for (var i = 0; i < 3; i++) {
                    g.lineTo(locs[i][0], locs[i][1])
                }
                g.strokeStyle = 'black'
                g.lineWidth = unitWidth / 3
                g.stroke()
            })
        }

        var noInteractionHighlight = _.makeSet(g_m.interactions.interaction || [])

        _.each(particles, function (p) {
            var pos = p.e8coord
            var x = dot(H, pos)
            var y = dot(V, pos)
            if (!p2p) {
                if (g_selection1_interactions[p.id] && !noInteractionHighlight[p.id])
                    renderParticle(g, x, y, scale, unitWidth * 6, p, null, 'cyan')
                if (g_m.interactions.selection1 == p.id)
                    renderParticle(g, x, y, scale, unitWidth * 7, p, null, 'blue')
                if (g_m.interactions.over == p.id)
                    renderParticle(g, x, y, scale, unitWidth * 3, p)
            }
            renderParticle(g, x, y, scale, unitWidth/3, p, p2p)
        })

        return c
    }

    var d = $('<div/>')
    var updateP2P = true
    function update() {
        d.empty().append(draw())
        if (updateP2P)
            updatePixelToParticleMap()
        else
            pixelToParticleMap = null
    }

    update()
    var downPos = null
    grabMouseRelative(d, function (dx, dy, x, y) {
        if (!downPos) downPos = [x, y]
        updateP2P = false
        if (dx == 0 && dy == 0) return

        // H = current Horizontal view plane vector (8D)
        // V = current Vertical view plane vector
        // ax = horizontal rotation angle from user's horizontal mouse drag in viewport
        // ay = vertical rotation angle from user's vertical mouse drag in viewport
        // a = H-axis vector chosen (on left) to rotate towards
        // A = V-axis vector chosen to rotate towards
        // g,G = temporary vectors
        // H', V' = result

        // g = a - (a.V)V - (a.H)H
        // G = A - (A.V)V - (A.H)H
        // g = g/|g|
        // G = G/|G|
        // H' = H cos ax + g sin ax
        // H' = H'/|H'|
        // V' = V - (V.H')H'
        // V' = V'/|V'|
        // V' = V' cos ay + G sin ay
        // V' = V'/|V'|

        // for flat rotation
        // H' = H cos - V sin
        // V' = V cos + H sin        

        var H = g_m.rotate.H
        var V = g_m.rotate.V

        if (g_m.rotate.rotateZ) {
            var pos = d.offset()
            pos = [
                x - (pos.left + w/2),
                y - (pos.top + h/2)
            ]
            var prevPos = sub(pos, [dx, dy])
            var prevAngle = Math.atan2(-prevPos[1], prevPos[0])
            var angle = Math.atan2(-pos[1], pos[0])
            var da = angle - prevAngle
            if (da < 0) da += tau
            var a = Math.atan2(pos[1], pos[0])
            var H_ = sub(mul(H, Math.cos(da)), mul(V, Math.sin(da)))
            var V_ = add(mul(V, Math.cos(da)), mul(H, Math.sin(da)))
            H_ = norm(H_)
            V_ = norm(V_)
        } else {
            var radiansPerPixel = tau / 1000
            var ax = dx * radiansPerPixel
            var ay = dy * radiansPerPixel

            var a = zeros(8)
            a[g_m.rotate.axes[0]] = 1
            var A = zeros(8)
            A[g_m.rotate.axes[1]] = 1

            var g = sub(sub(a, mul(dot(a, V), V)), mul(dot(a, H), H))
            var G = sub(sub(A, mul(dot(A, V), V)), mul(dot(A, H), H))
            g = norm(g)
            G = norm(G)

            var H_ = add(mul(H, Math.cos(ax)), mul(g, Math.sin(ax)))
            H_ = norm(H_)
            V_ = sub(V, mul(dot(V, H_), H_))
            V_ = norm(V_)
            V_ = add(mul(V_, Math.cos(ay)), mul(G, Math.sin(ay)))
            V_ = norm(V_)
        }

        beginModelChange()
        g_m.rotate.H = H_
        g_m.rotate.V = V_
        endModelChange()
    }, function (x, y) {
        updateP2P = true
        update()

        if (dist(sub([x, y], downPos)) < 5) {
            var id = getOverParticle({ pageX : x, pageY : y })
            if (id) {
                beginModelChange()
                var i = g_selection1_interactions[id]
                if (g_m.interactions.selection1 && i) {
                    g_m.interactions.selection2 = id
                    g_m.interactions.result = i[0]
                    g_m.interactions.interaction = i[1]
                } else {
                    g_m.interactions.selection1 = id
                    g_m.interactions.selection2 = null
                    g_m.interactions.result = null
                    g_m.interactions.interaction = null
                    g_selection1_interactions = {}
                    _.each(interactions, function (i) {
                        if (i.indexOf(id) != -1) {
                            var others = []
                            _.each(i, function (i) {
                                if (i != id)
                                    others.push(i)
                            })
                            g_selection1_interactions[others[0]] = [others[1], i]
                            g_selection1_interactions[others[1]] = [others[0], i]
                        }
                    })
                }
                endModelChange()
            }
        }
        downPos = null
    })

    function getOverParticle(e) {
        if (pixelToParticleMap) {
            var pos = getRelPos(d, e)
            var base = pos[0]*4 + pos[1]*4*w

            return p2p_color_to_id(pixelToParticleMap[base], pixelToParticleMap[base+1], pixelToParticleMap[base+2], pixelToParticleMap[base+3])
        }
    }

    d.on('mousemove', function (e) {
        beginModelChange()
        g_m.interactions.over = getOverParticle(e) || 0
        endModelChange()
    })

    d.addClass('onModelChange')[0].onModelChange = function () {

        var diff = false
        for (var i = 0; i < g_m.rotate.H.length; i++) {
            if (g_m.rotate.H[i] != g_old_m.rotate.H[i]) {
                diff = true
                break
            }
            if (g_m.rotate.V[i] != g_old_m.rotate.V[i]) {
                diff = true
                break
            }
        }
        if (diff || isModelDifferent('showAxes', 'showTriality', 'interactions.over', 'interactions.selection1', 'interactions.selection2', 'interactions.result')) {
            update()
        }
    }

    return d
}

function drawInteractions() {
    function drawCell(content, cols, align) {
        var c = $('<td width="' + ((cols || 1) * 6.666666666) + '%" colspan="' + (cols || 1) + '"/>')
        c.attr('align', align || 'middle')
        if (typeof(content) == 'string')
            c.append($('<div style="max-height:34px;vertical-align:middle;overflow:hidden;"/>').text(content))
        else
            c.append(content)
        return c
    }
    function addParticle(r, p, theory) {
        r.append(drawCell(p.label, 3, 'left'))
        r.append(drawCell('X'))

        var size = g_rowHeight
        var c = $('<canvas/>').attr('width', size).attr('height', size)
        var g = c.get()[0].getContext("2d")
        g.setTransform(size/2, 0, 0, -size/2, size/2, size/2)
        renderParticle(g, 0, 0, 1, 1/size, p)
        r.append(drawCell(c))


        function drawNumber(a) {
            function formatNumber(a) {
                a = a.replace(/SQRT\((.*?)\)/g, function (_0, _1) {
                    return '&radic;<span style="text-decoration:overline">' + _1 + '</span>'
                })
                a = a.replace(/[\(\)]/g, '')
                return a
            }
            a = a.split(/\//)
            if (a.length == 2) {
                return $('<table style="font-size:small;text-align:center"><tr style="border-bottom:1px solid black"><td>' + formatNumber(a[0]) + '</td></tr><tr><td>' + formatNumber(a[1]) + '</td></tr></table>')
            } else {
                return $('<div/>').html(formatNumber(a[0]))
            }
        }
        _.each(p[theory + 'coordlbl'].split(/,/), function (a) {
            r.append(drawCell(drawNumber(a)))
        })
    }
    function drawParticles(theory) {
        var headers = ['Over', 'Selection1', 'Selection2', 'Result']
        return _.map(headers, function (h, i) {
            var r = $('<tr height="' + g_rowHeight + 'px"/>')
            r.append(drawCell(h, 2, 'right').css('padding-right', '20px')).css('background', i % 2 == 0 ? 'white' : '#f0f0f0')

            var p = g_m.interactions[h.toLowerCase()]
            if (p) {
                p = particles[1*p - 1]
                addParticle(r, p, theory)
            } else {
                r.append(drawCell($('<div/>'), 13))
            }
            return r
        })
    }
    function drawHeader() {
        var r = $('<tr height="' + g_rowHeight + 'px" style="background: linear-gradient(to bottom, white, lightgrey);"/>')
        r.append(drawCell($('<button/>').text('Deselect All').click(function () {
            beginModelChange()
            g_m.interactions = {}
            g_selection1_interactions = {}
            endModelChange()
        }), 2, 'left'))

        var checks = $('<div style="font-size:small"/>').append(createCheckBox('Show Axes', g_m.showAxes, function () {
            beginModelChange()
            g_m.showAxes = !g_m.showAxes
            endModelChange()
        }).css('margin-right', '10px')).append(createCheckBox('Show Triality', g_m.showTriality, function () {
            beginModelChange()
            g_m.showTriality = !g_m.showTriality
            endModelChange()
        }))
        r.append(drawCell(checks, 4, 'left'))

        var size = g_rowHeight
        var c = $('<canvas/>').attr('width', size).attr('height', size)
        var g = c.get()[0].getContext("2d")
        g.setTransform(size/2, 0, 0, -size/2, size/2, size/2)
        renderParticle(g, 0.3, 0.3, 1, 1/size, { symbol : 'scir', color : 'mrora' })
        renderParticle(g, 0, 0, 1, 1/size, { symbol : 'msqu', color : 'mblue' })
        renderParticle(g, -0.3, -0.3, 1, 1/size, { symbol : 'sdia', color : 'mgree' })
        r.append(drawCell(c))

        var headers = [
            'ω<sub>S</sub>',
            'iω<sub>T</sub>',
            'W',
            'Y',
            'iw',
            'X',
            m.c(m.i('g'), m.supsub(m.x(3), null)),
            m.c(m.i('g'), m.supsub(m.x(8), null))
        ]
        _.each(headers, function (h) {
            if (typeof(h) == 'string') h = $('<i style="font-family:serif"/>').html(h)
            r.append(drawCell(h))
        })
        return r
    }

    var d = $('<div/>')
    function update() {
        var t = $('<table style="width:800px;margin:5px"/>')
        t.append(drawHeader())
        t.append(drawParticles('gut'))
        d.empty().append(t)
    }
    update()

    d.addClass('onModelChange')[0].onModelChange = function () {
        if (isModelDifferent('showAxes', 'showTriality', 'interactions.over', 'interactions.selection1', 'interactions.selection2', 'interactions.result')) {
            update()
        }
    }
    return d
}

function drawRotationPanel() {
    function drawRotate(yes, cb) {
        var w = g_rowHeight
        var h = g_rowHeight
        var c = $('<canvas/>').attr('width', w).attr('height', h)
        var g = c[0].getContext('2d')
        g.setTransform(w/2, 0, 0, -h/2, w/2, h/2)
        var unitWidth = 2/w
        g.lineWidth = unitWidth

        var color = yes ? 'black' : 'lightgrey'
        var colorOver = null

        function render() {
            g.clearRect(-1, -1, 2, 2)

            g.strokeStyle = colorOver || color
            g.fillStyle = colorOver || color

            g.beginPath()
            g.arc(0, 0, .6, tau, tau/8*7)
            g.lineWidth = 3 * unitWidth
            g.stroke()

            g.beginPath()
            g.moveTo(.3, 0)
            g.lineTo(.9, 0)
            g.lineTo(.6, -.4)
            g.closePath()
            g.fill()
        }
        render()

        function on(e) {
            colorOver = 'blue'
            render()
        }
        c.on('mouseover', on).on('mousemove', on)
        c.on('mouseout', function (e) {
            colorOver = null
            render()
        })
        c.on('click', function (e) {
            cb()
        })

        return c        
    }
    function drawArrowCross(horz, vert, cb) {
        var w = g_rowHeight
        var h = g_rowHeight
        var c = $('<canvas/>').attr('width', w).attr('height', h)
        var g = c[0].getContext('2d')
        g.setTransform(w/2, 0, 0, -h/2, w/2, h/2)
        g.lineWidth = 2/w

        var circleColor = horz || vert ? 'black' : 'lightgrey'
        var horzColor = horz ? 'black' : 'lightgrey'
        var vertColor = vert ? 'black' : 'lightgrey'
        var circleColorOver = null
        var horzColorOver = null
        var vertColorOver = null
        function render() {
            g.clearRect(-1, -1, 2, 2)

            function renderArrow(r, color) {
                g.rotate(r)
                g.beginPath()
                g.moveTo(.15, 0)
                g.lineTo(.15, .5)
                g.lineTo(.4, .5)
                g.lineTo(0, 1)
                g.lineTo(-.4, .5)
                g.lineTo(-.15, .5)
                g.lineTo(-.15, 0)
                g.closePath()
                g.fillStyle = color
                g.fill()
                g.setTransform(w/2, 0, 0, -h/2, w/2, h/2)
            }
            renderArrow(0, vertColorOver || vertColor)
            renderArrow(tau / 4, horzColorOver || horzColor)
            renderArrow(tau / 2, vertColorOver || vertColor)
            renderArrow(tau / 4 * 3, horzColorOver || horzColor)

            g.beginPath()
            g.arc(0, 0, .35, 0, tau)
            g.fillStyle = circleColorOver || circleColor
            g.fill()

            g.beginPath()
            g.arc(0, 0, .15, 0, tau)
            g.fillStyle = 'white'
            g.fill()
        }
        render()

        function getHorzVert(e) {
            var pos = getRelPos(c, e)
            var x = _.lerp(0, -1, w, 1, pos[0])
            var y = _.lerp(0, 1, h, -1, pos[1])
            return [(y > -.4 && y < .4), (x > -.4 && x < .4)]
        }
        function on(e) {
            var x = getHorzVert(e)
            horzColorOver = x[0] ? 'blue' : null
            vertColorOver = x[1] ? 'blue' : null
            circleColorOver = x[0] || x[1] ? 'blue' : null
            render()
        }
        c.on('mouseover', on).on('mousemove', on)
        c.on('mouseout', function (e) {
            circleColorOver = null
            horzColorOver = null
            vertColorOver = null
            render()
        })
        c.on('click', function (e) {
            var x = getHorzVert(e)
            cb(x[0], x[1])
        })

        return c
    }
    function drawCell(content, align) {
        var c = $('<td width="25%"/>')
        c.attr('align', align || 'middle')
        if (typeof(content) == 'string')
            c.append($('<div style="max-height:' + g_rowHeight + 'px;vertical-align:middle;overflow:hidden;"/>').text(content))
        else
            c.append(content)
        return c
    }
    function drawRow(label, i) {
        var r = $('<tr height="' + g_rowHeight + '">')
        r.append(drawCell($('<div style="font-family:serif;font-style:italic"/>').html(label)))
        r.append(drawCell($('<div class="H' + i + '" style="font-family:serif"/>')))
        r.append(drawCell($('<div class="V' + i + '" style="font-family:serif"/>')))
        r.append(drawCell(drawArrowCross(g_m.rotate.axes[0] == i, g_m.rotate.axes[1] == i, function (horz, vert) {
            beginModelChange()
            if (horz) g_m.rotate.axes[0] = i
            if (vert) g_m.rotate.axes[1] = i
            g_m.rotate.rotateZ = false
            endModelChange()
        })))
        return r
    }
    function drawHeader() {
        var r = $('<tr height="' + g_rowHeight + 'px" style="background: linear-gradient(to bottom, white, lightgrey);"/>')
        r.append(drawCell($('<div style="font-size:small"/>').text('Rotation')))
        r.append(drawCell('H'))
        r.append(drawCell('V'))
        r.append(drawCell(drawRotate(g_m.rotate.rotateZ, function () {
            beginModelChange()
            g_m.rotate.rotateZ = !g_m.rotate.rotateZ
            endModelChange()
        })))
        return r
    }
    function updateHV() {
        for (var i = 0; i < g_m.rotate.H.length; i++) {
            d.find('.H' + i).text(g_m.rotate.H[i].toFixed(2))
            d.find('.V' + i).text(g_m.rotate.V[i].toFixed(2))
        }
    }

    var d = $('<div style="margin:5px"/>')
    function update() {
        var t = $('<table width="180px;height:324px"/>')
        t.append(drawHeader())

        var rows = [
            'ω<sub>S</sub>',
            'iω<sub>T</sub>',
            m.c(m.sqrt(m.x(2)), m.i('W')),
            m.c(m.f(m.sqrt(m.x(3)), m.sqrt(m.x(10))), m.i('Y')),
            'iw',
            m.c(m.f(m.x(1), m.sqrt(m.x(5))), m.i('X')),
            m.c(m.c(m.sqrt(m.x(2)), m.i('g')), m.supsub(m.x(3), null)),
            m.c(m.c(m.sqrt(m.x(2)), m.i('g')), m.supsub(m.x(8), null))
        ]
        rows = _.map(rows, function (r) {
            return typeof(r) == 'string' ? $('<i style="font-family:serif"/>').html(r) : r
        })
        _.each(rows, function (r, i) {
            t.append(drawRow(r, i).css('background', i % 2 == 0 ? 'white' : '#f0f0f0'))
        })
        d.empty().append(t)
        updateHV()
    }
    update()
    d.addClass('onModelChange')[0].onModelChange = function () {
        var diff = false
        for (var i = 0; i < g_m.rotate.H.length; i++) {
            if (g_m.rotate.H[i] != g_old_m.rotate.H[i]) {
                diff = true
                break
            }
            if (g_m.rotate.V[i] != g_old_m.rotate.V[i]) {
                diff = true
                break
            }
        }
        if (diff) updateHV()
        if (isModelDifferent('rotate.axes[0]', 'rotate.axes[1]', 'rotate.rotateZ')) {
            update()
        }
    }
    return d
}

function updateMain() {
    w = $('body')[0].clientWidth
    h = $('body')[0].clientHeight
    var bottomHeight = g_rowHeight * 5 + 10
    var sideWidth = 190
    size = Math.min(w - sideWidth, h - bottomHeight)

    var d = $('<div/>').width(w).height(h)
    d.append(_.splitVert(1, bottomHeight, _.splitHorz(sideWidth, 1, drawRotationPanel(), drawVisualization(size, size)), drawInteractions()))
    $('body').empty().append(d)
}

var g_m = null
var g_old_m = null
function beginModelChange() {
    g_old_m = _.deepClone(g_m)
}
function endModelChange() {
    _.each($('.onModelChange').get(), function (o) {
        o.onModelChange()
    })
}
function isModelDifferent() {
    for (var i = 0; i < arguments.length; i++) {
        var a = arguments[i]
        if (eval('g_m.' + a + ' != g_old_m.' + a)) return true
    }
    return false
}

$(function () {
    g_m = {
        showAxes : true,
        showTriality : true,
        rotate : {
            x : 0,
            y : 0,
            H : [0, 0.67, -0.66, 0, -0.1, 0, 0.34, 0],
            V : [0.92, 0, 0, 0.09, 0, 0.38, 0, 0.02],
            axes : [0, 1],
            rotateZ : false
        },
        interactions : {
            over : null,
            selection1 : null,
            selection2 : null,
            result : null,
            interaction : null
        }
    }
    g_selection1_interactions = {}

    $(window).resize(updateMain)
    updateMain()
})

</script>

</body>
</html>
