<html>
<head>
<meta charset='utf-8'>
<title>E8</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 0px;
    font-family: sans-serif;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="utils.js"></script>
<script src="particles.js"></script>
<script>

function normalizeCoord(v, i) {
    var left = 1 - v[i] * v[i]
    var den = 0
    for (var j = 0; j < v.length; j++) {
        if (j != i) den += v[j] * v[j]
    }
    for (var j = 0; j < v.length; j++) {
        if (j != i) v[j] = Math.sqrt(left * (v[j] * v[j] / den)) * (v[j] < 0 ? -1 : 1)
    }
    return v
}

function p2p_id_to_color(id) {
    var low = id % 16
    var high = Math.floor(id / 16)
    var r = low * 16 + low
    var g = high * 16 + high
    var b = high * 16 + low
    return 'rgb(' + r + ',' + g + ',' + b + ')'
}

function p2p_color_to_id(r, g, b, a) {
    if (a != 255) return
    var low = r % 16
    if (low != Math.floor(r / 16)) return
    var high = g % 16
    if (high != Math.floor(g / 16)) return
    if (high != Math.floor(b / 16)) return
    if (low != b % 16) return
    return high * 16 + low
}

;(function () {
    function circle(g, x, y, size) {
        g.beginPath()
        g.arc(x, y, size, 0, tau)
    }
    function square(g, x, y, size) {
        g.beginPath()
        g.moveTo(x - size, y - size)
        g.lineTo(x - size, y + size)
        g.lineTo(x + size, y + size)
        g.lineTo(x + size, y - size)
        g.closePath()
    }
    function dia(g, x, y, size) {
        g.beginPath()
        g.lineTo(x - size, y)
        g.lineTo(x, y + size)
        g.lineTo(x + size, y)
        g.lineTo(x, y - size)
        g.closePath()
    }
    var glyphu = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [-1/2, 1/Math.sqrt(3)],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var glyphd = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-3/4, 1/(4 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var sizeMap = {
        's' : .75,
        'm' : .85,
        'b' : 1.0
    }
    function glyph(g, x, y, scale, sym) {
        var size = scale * sizeMap[sym[0]]
        var mx = size * (sym[1] == 'l' ? 1 : -1)
        var my = size * (sym[3] == 'p' ? 1 : -1)
        var gl = (sym[2] == 'u') == (sym[3] == 'p') ? glyphu : glyphd
        g.beginPath()
        for (var i = 0; i < gl.length; i++) {
            if (i == 0)
                g.moveTo(x + mx * gl[i][0], y + my * gl[i][1])
            else
                g.lineTo(x + mx * gl[i][0], y + my * gl[i][1])
        }
        g.closePath()
    }
    renderParticle = function (g, x, y, scale, lineWidth, p, p2p, justLine) {
        if (p2p) p2p = p2p_id_to_color(p.id)
        var size = p.symbol[0] == 's' ? .8 : 1
        var sym = p.symbol.slice(1)
        if (sym == 'cir') {
            circle(g, x, y, size * scale / 2)
        } else if (sym == 'squ') {
            square(g, x, y, size * .4 * scale)
        } else if (sym == 'dia') {
            dia(g, x, y, size * .4 * Math.sqrt(2) * scale)
        } else {
            glyph(g, x, y, scale, p.symbol)
        }
        if (!justLine) {
            g.fillStyle = p2p || colorMap[p.color]
            g.fill()
        }
        g.strokeStyle = p2p || justLine || 'black'
        g.lineWidth = lineWidth
        g.stroke()
    }
})();

function drawVisualization(w, h) {

    var pixelToParticleMap = null

    function updatePixelToParticleMap() {
        var c = draw(true)
        var g = c[0].getContext('2d')
        pixelToParticleMap = g.getImageData(0, 0, w, h).data
    }

    function draw(p2p) {
        var c = $('<canvas/>').attr('width', w).attr('height', h)
        var g = c[0].getContext('2d')
        g.setTransform(w/3, 0, 0, -h/3, w/2, h/2)
        var unitWidth = 3/w

        var H = [0, 0.67, -0.66, 0, -0.1, 0, 0.34, 0]
        var V = [0.92, 0, 0, 0.09, 0, 0.38, 0, 0.02]
        H[0] = Math.sin(_.lerp(0, 0, 1000, tau, g_m.rotate.x))
        V[0] = -Math.sin(_.lerp(0, 0, 1000, tau, g_m.rotate.y))
        normalizeCoord(H, 0)
        normalizeCoord(V, 0)
        // var H = [1, 0, 0, 0, 0, 0, 0, 0]
        // var V = [0, 1, 0, 0, 0, 0, 0, 0]

        function projectParticle(id) {
            var p = particles[id - 1]
            return [dot(H, p.e8coord), dot(V, p.e8coord)]
        }

        var scale = 0.1

        if (!p2p && g_m.interactions.interaction) {
            var x = _.map(g_m.interactions.interaction, projectParticle)

            g.beginPath()
            g.moveTo(x[0][0], x[0][1])
            g.lineTo(x[1][0], x[1][1])
            g.lineWidth = unitWidth * 7
            g.strokeStyle = 'yellow'
            g.stroke()

            g.beginPath()
            g.arc(x[0][0], x[0][1], scale, 0, tau)
            g.fillStyle = 'yellow'
            g.fill()

            g.beginPath()
            g.arc(x[1][0], x[1][1], scale, 0, tau)
            g.fillStyle = 'yellow'
            g.fill()

            g.beginPath()
            g.moveTo(0, 0)
            g.lineTo(x[2][0], x[2][1])
            g.lineWidth = unitWidth * 7
            g.strokeStyle = 'lightgreen'
            g.stroke()

            g.beginPath()
            g.arc(x[2][0], x[2][1], scale, 0, tau)
            g.fillStyle = 'lightgreen'
            g.fill()
        }

        if (g_m.showTriality && !p2p) {
            _.each(trialities, function (t) {
                var locs = _.map(t, projectParticle)
                g.beginPath()
                g.moveTo(locs[2][0], locs[2][1])
                for (var i = 0; i < 3; i++) {
                    g.lineTo(locs[i][0], locs[i][1])
                }
                g.strokeStyle = 'black'
                g.lineWidth = unitWidth / 3
                g.stroke()
            })
        }

        var noInteractionHighlight = _.makeSet(g_m.interactions.interaction || [])

        _.each(particles, function (p) {
            var pos = p.e8coord
            var x = dot(H, pos)
            var y = dot(V, pos)
            if (!p2p) {
                if (g_selection1_interactions[p.id] && !noInteractionHighlight[p.id])
                    renderParticle(g, x, y, scale, unitWidth * 6, p, null, 'cyan')
                if (g_m.interactions.selection1 == p.id)
                    renderParticle(g, x, y, scale, unitWidth * 7, p, null, 'blue')
                if (g_m.interactions.over == p.id)
                    renderParticle(g, x, y, scale, unitWidth * 3, p)
            }
            renderParticle(g, x, y, scale, unitWidth/3, p, p2p)
        })

        return c
    }

    var d = $('<div/>')
    var updateP2P = true
    function update() {
        d.empty().append(draw())
        if (updateP2P)
            updatePixelToParticleMap()
        else
            pixelToParticleMap = null
    }

    update()
    var downPos = null
    grabMouseRelative(d, function (dx, dy, x, y) {
        if (!downPos) downPos = [x, y]
        updateP2P = false
        beginModelChange()
        g_m.rotate.x += dx
        g_m.rotate.y += dy
        endModelChange()
    }, function (x, y) {
        updateP2P = true
        update()

        if (dist(sub([x, y], downPos)) < 5) {
            var id = getOverParticle({ pageX : x, pageY : y })
            if (id) {
                beginModelChange()
                var i = g_selection1_interactions[id]
                if (g_m.interactions.selection1 && i) {
                    g_m.interactions.selection2 = id
                    g_m.interactions.result = i[0]
                    g_m.interactions.interaction = i[1]
                } else {
                    g_m.interactions.selection1 = id
                    g_m.interactions.interaction = null
                    g_selection1_interactions = {}
                    _.each(interactions, function (i) {
                        if (i.indexOf(id) != -1) {
                            var others = []
                            _.each(i, function (i) {
                                if (i != id)
                                    others.push(i)
                            })
                            g_selection1_interactions[others[0]] = [others[1], i]
                            g_selection1_interactions[others[1]] = [others[0], i]
                        }
                    })
                }
                endModelChange()
            }
        }
        downPos = null
    })

    function getOverParticle(e) {
        if (pixelToParticleMap) {
            var pos = d.offset()
            var x = e.pageX - pos.left
            var y = e.pageY - pos.top
            var base = x*4 + y*4*w

            return p2p_color_to_id(pixelToParticleMap[base], pixelToParticleMap[base+1], pixelToParticleMap[base+2], pixelToParticleMap[base+3])
        }
    }

    d.on('mousemove', function (e) {
        beginModelChange()
        g_m.interactions.over = getOverParticle(e) || 0
        endModelChange()
    })

    d.addClass('onModelChange')[0].onModelChange = function () {
        if (isModelDifferent('showAxes', 'showTriality', 'rotate.x', 'rotate.y', 'interactions.over', 'interactions.selection1', 'interactions.selection2', 'interactions.result')) {
            update()
        }
    }

    return d
}

function drawInteractions() {
    function drawCell(content, cols, align) {
        var c = $('<td width="' + ((cols || 1) * 6.666666666) + '%" colspan="' + (cols || 1) + '"/>')
        c.attr('align', align || 'middle')
        if (typeof(content) == 'string')
            c.append($('<div style="max-height:34px;vertical-align:middle;overflow:hidden;"/>').text(content))
        else
            c.append(content)
        return c
    }
    function addParticle(r, p, theory) {
        r.append(drawCell(p.label, 3, 'left'))
        r.append(drawCell('X'))

        var size = 34
        var c = $('<canvas/>').attr('width', size).attr('height', size)
        var g = c.get()[0].getContext("2d")
        g.setTransform(size/2, 0, 0, -size/2, size/2, size/2)
        renderParticle(g, 0, 0, 1, 1/size, p)
        r.append(drawCell(c))

        _.each(p[theory + 'coordlbl'].split(/,/), function (a) {
            function formatNumber(a) {
                a = a.replace(/SQRT\((.*?)\)/g, function (_0, _1) {
                    return '&radic;<span style="text-decoration:overline">' + _1 + '</span>'

                })
                a = a.replace(/[\(\)]/g, '')
                return a
            }
            function drawFraction(a) {
                a = a.split(/\//)
                if (a.length == 2) {
                    var t = $('<table style="font-size:small;text-align:center"/>')
                    t.append($('<tr style="border-bottom:1px solid black"/>').append($('<td/>').html(formatNumber(a[0]))))
                    t.append($('<tr/>').append($('<td/>').html(formatNumber(a[1]))))
                    return t
                } else {
                    return $('<div/>').text(a)
                }
            }
            r.append(drawCell(drawFraction(a)))
        })
    }
    function drawParticles(theory) {
        var headers = ['Over', 'Selection1', 'Selection2', 'Result']
        return _.map(headers, function (h, i) {
            var r = $('<tr height="34px"/>')
            r.append(drawCell(h, 2, 'right').css('padding-right', '20px')).css('background', i % 2 == 0 ? 'white' : '#e0e0e0')

            var p = g_m.interactions[h.toLowerCase()]
            if (p) {
                p = particles[1*p - 1]
                addParticle(r, p, theory)
            } else {
                r.append(drawCell($('<div/>'), 13))
            }
            return r
        })
    }
    function drawHeader() {
        var r = $('<tr height="34px" style="background: linear-gradient(to bottom, white, lightgrey);"/>')
        r.append(drawCell($('<button/>').text('Deselect All').click(function () {
            beginModelChange()
            g_m.interactions = {}
            g_selection1_interactions = {}
            endModelChange()
        }), 2, 'left'))

        var checks = $('<div style="font-size:small"/>').append(createCheckBox('Show Axes', g_m.showAxes, function () {
            beginModelChange()
            g_m.showAxes = !g_m.showAxes
            endModelChange()
        }).css('margin-right', '10px')).append(createCheckBox('Show Triality', g_m.showTriality, function () {
            beginModelChange()
            g_m.showTriality = !g_m.showTriality
            endModelChange()
        }))
        r.append(drawCell(checks, 4, 'left'))

        var size = 34
        var c = $('<canvas/>').attr('width', size).attr('height', size)
        var g = c.get()[0].getContext("2d")
        g.setTransform(size/2, 0, 0, -size/2, size/2, size/2)
        renderParticle(g, 0.3, 0.3, 1, 1/size, { symbol : 'scir', color : 'mrora' })
        renderParticle(g, 0, 0, 1, 1/size, { symbol : 'msqu', color : 'mblue' })
        renderParticle(g, -0.3, -0.3, 1, 1/size, { symbol : 'sdia', color : 'mgree' })
        r.append(drawCell(c))

        r.append(drawCell($('<i style="font-family:serif">ω<sub>S</sub></i>')))
        r.append(drawCell($('<i style="font-family:serif">iω<sub>T</sub></i>')))
        r.append(drawCell($('<i style="font-family:serif">W</i>')))
        r.append(drawCell($('<i style="font-family:serif">Y</i>')))
        r.append(drawCell($('<i style="font-family:serif">iw</i>')))
        r.append(drawCell($('<i style="font-family:serif">X</i>')))
        r.append(drawCell($('<i style="font-family:serif">g<sup>3</sup></i>')))
        r.append(drawCell($('<i style="font-family:serif">g<sup>8</sup></i>')))
        return r
    }

    var d = $('<div/>')
    function update() {
        var t = $('<table style="width:800px;margin:5px"/>')
        t.append(drawHeader())
        t.append(drawParticles('gut'))
        d.empty().append(t)
    }
    update()

    d.addClass('onModelChange')[0].onModelChange = function () {
        if (isModelDifferent('showAxes', 'showTriality', 'interactions.over', 'interactions.selection1', 'interactions.selection2', 'interactions.result')) {
            update()
        }
    }
    return d
}

function updateMain() {
    w = $('body')[0].clientWidth
    h = $('body')[0].clientHeight
    size = Math.min(w, h - 180)

    var d = $('<div/>').width(w).height(h)
    d.append(_.splitVert(1, 180, drawVisualization(size, size), drawInteractions()))
    $('body').empty().append(d)
}

var g_m = null
var g_old_m = null
function beginModelChange() {
    g_old_m = _.deepClone(g_m)
}
function endModelChange() {
    _.each($('.onModelChange').get(), function (o) {
        o.onModelChange()
    })
}
function isModelDifferent() {
    for (var i = 0; i < arguments.length; i++) {
        var a = arguments[i]
        if (eval('g_m.' + a + ' != g_old_m.' + a)) return true
    }
    return false
}

$(function () {
    g_m = {
        showAxes : true,
        showTriality : true,
        rotate : {
            x : 0,
            y : 0
        },
        interactions : {
            over : null,
            selection1 : null,
            selection2 : null,
            result : null,
            interaction : null
        }
    }
    g_selection1_interactions = {}

    $(window).resize(updateMain)
    updateMain()
})

</script>

</body>
</html>
