<html>
<head>
<title>E8</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 0px;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="utils.js"></script>
<script src="particles.js"></script>
<script>

function normalizeCoord(v, i) {
    var left = 1 - v[i] * v[i]
    var den = 0
    for (var j = 0; j < v.length; j++) {
        if (j != i) den += v[j] * v[j]
    }
    for (var j = 0; j < v.length; j++) {
        if (j != i) v[j] = Math.sqrt(left * (v[j] * v[j] / den)) * (v[j] < 0 ? -1 : 1)
    }
    return v
}

function drawSomeStuff(w, h) {
    var c = $('<canvas/>').attr('width', w).attr('height', h)
    var g = c.get()[0].getContext("2d")
    g.setTransform(w/3, 0, 0, -h/3, w/2, h/2)
    g.lineWidth = 1/w

    var H = [0, 0.67, -0.66, 0, -0.1, 0, 0.34, 0]
    var V = [0.92, 0, 0, 0.09, 0, 0.38, 0, 0.02]
    H[0] = Math.sin(_.lerp(0, 0, 1000, tau, g_x))
    V[0] = -Math.sin(_.lerp(0, 0, 1000, tau, g_y))
    normalizeCoord(H, 0)
    normalizeCoord(V, 0)
    // var H = [1, 0, 0, 0, 0, 0, 0, 0]
    // var V = [0, 1, 0, 0, 0, 0, 0, 0]

    _.each(trialities, function (t) {
        var locs = _.map(t, function (t) {
            return [
                dot(H, particles[t - 1].e8coord),
                dot(V, particles[t - 1].e8coord)
            ]
        })
        g.beginPath()
        g.moveTo(locs[2][0], locs[2][1])
        for (var i = 0; i < 3; i++) {
            g.lineTo(locs[i][0], locs[i][1])
        }
        g.strokeStyle = 'black'
        g.stroke()
    })

    function circle(x, y, size) {
        g.arc(x, y, size, 0, tau)
    }
    function square(x, y, size) {
        g.moveTo(x - size, y - size)
        g.lineTo(x - size, y + size)
        g.lineTo(x + size, y + size)
        g.lineTo(x + size, y - size)
        g.lineTo(x - size, y - size)
    }
    function dia(x, y, size) {
        g.moveTo(x, y - size)
        g.lineTo(x - size, y)
        g.lineTo(x, y + size)
        g.lineTo(x + size, y)
        g.lineTo(x, y - size)
    }
    var glyphu = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [-1/2, 1/Math.sqrt(3)],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var glyphd = [
        [-1/2, -1/(2 * Math.sqrt(3))],
        [-3/4, 1/(4 * Math.sqrt(3))],
        [-1/4, 1/(4 * Math.sqrt(3))],
        [0, 1/(Math.sqrt(3))],
        [1/2, -1/(2 * Math.sqrt(3))]
    ]
    var sizeMap = {
        's' : .75,
        'm' : .85,
        'l' : 1.0
    }
    function glyph(x, y, scale, sym) {
        var size = scale * sizeMap[sym[0]]
        var mx = size * (sym[1] == 'l' ? 1 : -1)
        var my = size * (sym[3] == 'p' ? 1 : -1)
        var gl = (sym[2] == 'u') == (sym[3] == 'p') ? glyphu : glyphd
        g.moveTo(x + mx * gl[gl.length - 1][0], y + my * gl[gl.length - 1][1])
        for (var i = 0; i < gl.length; i++) {
            g.lineTo(x + mx * gl[i][0], y + my * gl[i][1])
        }
    }
    _.each(particles, function (p) {
        var pos = p.e8coord
        var x = dot(H, pos)
        var y = dot(V, pos)
        var color = colorMap[p.color]

        var scale = 0.1

        g.beginPath()
        g.fillStyle = color
        var size = p.symbol[0] == 's' ? .8 : 1
        var sym = p.symbol.slice(1)
        if (sym == 'cir') {
            circle(x, y, size * scale / 2)
        } else if (p.symbol == 'squ') {
            square(x, y, size * .4 * scale)
        } else if (p.symbol == 'dia') {
            dia(x, y, size * .4 * Math.sqrt(2) * scale)
        } else {
            glyph(x, y, scale, p.symbol)
        }
        g.fill()
    })

    return c
}

$(function () {
    g_x = 0
    g_y = 0

    var w = $(window).width()
    var h = $(window).height()
    var size = Math.min(w, h)

    $('body').append(drawSomeStuff(size, size))

    var lastX = 0
    var lastY = 0
    var on = false
    document.onmousedown = function (e) {
        lastX = e.x
        lastY = e.y
        on = true
    }
    document.onmousemove = function (e) {
        if (on) {
            g_x += e.x - lastX
            g_y += e.y - lastY
            lastX = e.x
            lastY = e.y
            $('body').empty().append(drawSomeStuff(size, size))
        }
    }
    document.onmouseup = function (e) {
        on = false
    }

    $(window).resize(function () {
        w = $('body')[0].clientWidth
        h = $('body')[0].clientHeight
        size = Math.min(w, h)

        $('body').empty().append(drawSomeStuff(size, size))
    })
})

</script>

</body>
</html>
